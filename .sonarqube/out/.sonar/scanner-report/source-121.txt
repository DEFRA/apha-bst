using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Apha.BST.Core.Entities;
using Apha.BST.Core;
using Apha.BST.Core.Interfaces;
using Apha.BST.DataAccess.Data;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;

namespace Apha.BST.DataAccess.Repositories
{
    public class TrainingRepository: RepositoryBase<Training>, ITrainingRepository
    {
        public const string Success = "SUCCESS";
        public const string Fail = "FAIL";
        public const string Exists = "EXISTS";
        public const string TrainingIdParameter = "@TraineeID";

        public TrainingRepository(BstContext context):base(context) { }        

        public async Task<List<TraineeTrainer>> GetAllTraineesAsync()
        {
            return await GetQueryableResultFor<TraineeTrainer>("EXEC sp_Trainee_Training_Select")
                .ToListAsync();
        }
        public async Task<IEnumerable<TrainerTraining>> GetTrainingByTraineeAsync(string traineeId)
        {
            var param = new SqlParameter(TrainingIdParameter, traineeId);

            return await GetQueryableResultFor<TrainerTraining>("EXEC sp_Training_Select @TraineeID", param)
                .ToListAsync();
        }
        
        public async Task<IEnumerable<TrainerTraining>> GetAllTrainingsAsync()
        {
            var param = new SqlParameter(TrainingIdParameter, DBNull.Value);
            return await GetQueryableResultFor<TrainerTraining>("EXEC sp_Training_Select @TraineeID", param)
                .ToListAsync();
        }

        //For TrainerHistory
        public async Task<IEnumerable<TrainerHistory>> GetTrainerHistoryAsync(int personId, string animalType)
        {
            var personIdParam = new SqlParameter("@PersonID", personId);
            var animalTypeParam = new SqlParameter("@AnimalType", animalType);

            return await GetQueryableResultFor<TrainerHistory>("EXEC sp_Trainer_TrainedBy_Trained @PersonID, @AnimalType", personIdParam, animalTypeParam)
                .ToListAsync();
        }

        //For TrainerTrained
        public async Task<IEnumerable<TrainerTrained>> GetTrainerTrainedAsync(int trainerId)
        {
            var param = new SqlParameter("@Trainer", trainerId);
            return await GetQueryableResultFor<TrainerTrained>("EXEC sp_Trainer_Has_Trained @Trainer", param)
                .ToListAsync();
        }

        public async Task<Training?> GetTrainingByKeysAsync(int traineeId, int trainerId, string species, DateTime dateTrained, string trainingType)
        {
            DateTime fromDate = dateTrained.Date;
            DateTime toDate = fromDate.AddDays(1);

            return await GetDbSetFor<Training>().FirstOrDefaultAsync(t =>
                t.PersonId == traineeId &&
                t.TrainerId == trainerId &&
                t.TrainingAnimal == species &&
                t.TrainingDateTime >= fromDate &&
                t.TrainingDateTime < toDate &&
                t.TrainingType == trainingType);
        }

        public async Task<string> UpdateTrainingAsync(EditTraining editTraining)
        {
            var parameters = new[]
            {
            new SqlParameter(TrainingIdParameter, editTraining.TraineeIdOld),
            new SqlParameter("@DateTrained", editTraining.TrainingDateTime),
            new SqlParameter("@DateTrainedOld", editTraining.TrainingDateTimeOld),
            new SqlParameter("@Species", editTraining.TrainingAnimal),
            new SqlParameter("@SpeciesOld", editTraining.TrainingAnimalOld),
            new SqlParameter("@Trainer",  editTraining.TrainerId),
            new SqlParameter("@TrainerOld", editTraining.TrainerIdOld),
            new SqlParameter("@TrainingType", editTraining.TrainingType)           
            };            
            try
            {
                await ExecuteSqlAsync(
                    "EXEC sp_Training_Update @TraineeID, @DateTrained, @DateTrainedOld, @Species, @SpeciesOld, @Trainer, @TrainerOld, @TrainingType",
                    parameters);
                return Success;

            }
            catch
            {
                               
                return Fail;
            }

        }


        public async Task<string> AddTrainingAsync(Training training)
        {
            var parameters = new[]
            {
            new SqlParameter(TrainingIdParameter, training.PersonId),
            new SqlParameter("@TrainerID", training.TrainerId),
            new SqlParameter("@Species", training.TrainingAnimal),
            new SqlParameter("@TrainingType", training.TrainingType),
            new SqlParameter("@DateTrained", training.TrainingDateTime),
            new SqlParameter
            {
                ParameterName = "@ReturnCode",
                SqlDbType = SqlDbType.TinyInt,
                Direction = ParameterDirection.Output,
                Value = 0
            }
            };
                await ExecuteSqlAsync(                  
                   "EXEC sp_Training_Add @TraineeID, @TrainerID, @Species, @DateTrained, @TrainingType, @ReturnCode OUT",
                    parameters);                    
            var returnCode = (byte)parameters[5].Value;

            if (returnCode == 1)
                return Exists; 

            return Success;             
        }

        public async Task<Persons?> GetPersonByIdAsync(int personId)
        {
            return await GetDbSetFor<Persons>().FirstOrDefaultAsync(p => p.PersonId == personId);
        }
        
        public async Task<string> DeleteTrainingAsync(int traineeId, string species, DateTime dateTrained)
        { 
            var parameters = new[]
            {
                 new SqlParameter(TrainingIdParameter, traineeId),
                 new SqlParameter("@Species", species),
                 new SqlParameter("@DateTrained", dateTrained)
            };

            try
            {
                await ExecuteSqlAsync("EXEC sp_Training_Delete @TraineeID, @Species, @DateTrained", parameters);
                return Success;
            }
            catch 
            {
                           
                return Fail;
            }          
        }


    }
}
